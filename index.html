<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra-Filtro Vital</title>
    <style>
        body { background: #000; color: #00FF00; font-family: monospace; text-align: center; padding: 10px; }
        #monitor { border: 3px solid #00FF00; background: #010; padding: 30px; margin: 20px auto; max-width: 300px; border-radius: 20px; }
        .bpm-grande { font-size: 70px; color: #FFD700; text-shadow: 0 0 20px #DAA520; }
        #onda { width: 100%; height: 40px; background: #020; margin-top: 15px; border-radius: 5px; position: relative; }
        #pulso-v { position: absolute; width: 0%; height: 100%; background: #f00; opacity: 0.5; }
        .btn { padding: 20px; width: 100%; background: #008080; color: white; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <h2>SINTONÍA FINA: PULSO REAL</h2>
    
    <div id="monitor">
        <div id="onda"><div id="pulso-v"></div></div>
        <span id="bpm-display" class="bpm-grande">--</span><br>
        BPM REAL
        <hr>
        ESTADO: <span id="st" style="color:#00FFFF">ESTABILIZANDO</span>
    </div>

    <button class="btn" onclick="iniciarUltraFiltro()">INICIAR LECTURA PURA</button>

    <script>
        let ultimoT = 0, listaBpm = [], aCtx;

        async function iniciarUltraFiltro() {
            if (!aCtx) aCtx = new (window.AudioContext || window.webkitAudioContext)();
            document.querySelector('.btn').style.display = 'none';

            window.addEventListener('devicemotion', (e) => {
                let z = Math.abs(e.acceleration.z || 0);
                
                // FILTRO DE UMBRAL ALTO (Evita ruido)
                if (z > 0.15) { 
                    let ahora = Date.now();
                    let intervalo = ahora - ultimoT;

                    // BLOQUEO DE REBOTE (Mínimo 600ms = Máximo 100 BPM)
                    // Si tu pulso es mayor a 100 en reposo, ajustaremos esto.
                    if (intervalo > 600) { 
                        let bpmInstantaneo = 60000 / intervalo;
                        
                        if (bpmInstantaneo < 180) {
                            listaBpm.push(bpmInstantaneo);
                            if (listaBpm.length > 8) listaBpm.shift();

                            let promedio = listaBpm.reduce((a, b) => a + b) / listaBpm.length;
                            document.getElementById('bpm-display').innerText = Math.round(promedio);
                            
                            sonarLatido();
                            animarPulso();
                        }
                        ultimoT = ahora;
                    }
                }
            });
        }

        function sonarLatido() {
            let o = aCtx.createOscillator();
            let g = aCtx.createGain();
            o.frequency.value = 60; // Tono muy grave, como un tambor
            g.gain.setValueAtTime(0.5, aCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, aCtx.currentTime + 0.2);
            o.connect(g).connect(aCtx.destination);
            o.start(); o.stop(aCtx.currentTime + 0.2);
        }

        function animarPulso() {
            let p = document.getElementById('pulso-v');
            p.style.width = "100%"; p.style.opacity = "1";
            setTimeout(() => { p.style.width = "0%"; p.style.opacity = "0"; }, 200);
        }
    </script>
</body>
</html>

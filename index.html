<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datalogger Bio-Escalar v2</title>
    <style>
        body { background: #000; color: #00FF00; font-family: 'Courier New', monospace; text-align: center; padding: 10px; }
        #monitor { border: 2px solid #00FF00; background: #010; padding: 20px; margin: 10px auto; max-width: 320px; border-radius: 15px; }
        .dato { font-size: 50px; color: #FFD700; }
        #timer { font-size: 18px; color: #00FFFF; margin-bottom: 10px; }
        .btn { padding: 15px; width: 90%; margin: 5px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        #btn-start { background: #006400; color: white; }
        #btn-stop { background: #8B0000; color: white; display: none; }
        #btn-dl { background: #DAA520; color: black; display: none; }
    </style>
</head>
<body>

    <h2>REGISTRO VITAL + SEÑAL</h2>

    <div id="monitor">
        <div id="timer">TIEMPO: 00:00</div>
        <span id="bpm-val" class="dato">00</span><br>BPM
        <hr>
        PUNTOS: <span id="puntos">0</span>
    </div>

    <button id="btn-start" class="btn" onclick="iniciarSesion()">INICIAR GRABACIÓN</button>
    <button id="btn-stop" class="btn" onclick="detenerSesion()">DETENER SESIÓN</button>
    <button id="btn-dl" class="btn" onclick="descargarCSV()">BAJAR MEMORIA (CSV)</button>

    <script>
        let memoria = [], activo = false, tInicio = 0, ultimoLatido = 0, ultimoMinutoNotificado = 0;
        let aCtx;

        async function iniciarSesion() {
            if (!aCtx) aCtx = new (window.AudioContext || window.webkitAudioContext)();
            tInicio = Date.now();
            activo = true;
            document.getElementById('btn-start').style.display = 'none';
            document.getElementById('btn-stop').style.display = 'block';
            
            window.addEventListener('devicemotion', grabarDatos);
            actualizarReloj();
        }

        function grabarDatos(e) {
            if (!activo) return;
            let ahora = Date.now();
            let segTranscurridos = (ahora - tInicio) / 1000;
            let z = e.acceleration.z || 0;

            // Lógica de detección de latido (Filtro de 400ms)
            if (Math.abs(z) > 0.08 && (ahora - ultimoLatido > 400)) {
                let bpm = Math.round(60000 / (ahora - ultimoLatido));
                if (bpm < 200) {
                    memoria.push({ t: segTranscurridos.toFixed(2), z: z.toFixed(4), bpm: bpm });
                    document.getElementById('bpm-val').innerText = bpm;
                    document.getElementById('puntos').innerText = memoria.length;
                    ultimoLatido = ahora;
                }
            }

            // SEÑAL DE MINUTO: Cada 60 segundos dispara sonido
            let minutoActual = Math.floor(segTranscurridos / 60);
            if (minutoActual > ultimoMinutoNotificado) {
                sonarConfirmacion();
                ultimoMinutoNotificado = minutoActual;
            }
        }

        function sonarConfirmacion() {
            let o = aCtx.createOscillator();
            let g = aCtx.createGain();
            o.frequency.setValueAtTime(880, aCtx.currentTime); // Tono claro
            g.gain.setValueAtTime(0, aCtx.currentTime);
            g.gain.linearRampToValueAtTime(0.5, aCtx.currentTime + 0.1);
            g.gain.exponentialRampToValueAtTime(0.001, aCtx.currentTime + 2.0); // Sonido largo
            o.connect(g).connect(aCtx.destination);
            o.start(); o.stop(aCtx.currentTime + 2.1);
        }

        function actualizarReloj() {
            if (!activo) return;
            let segs = Math.floor((Date.now() - tInicio) / 1000);
            let m = Math.floor(segs / 60).toString().padStart(2, '0');
            let s = (segs % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `TIEMPO: ${m}:${s}`;
            requestAnimationFrame(actualizarReloj);
        }

        function detenerSesion() {
            activo = false;
            document.getElementById('btn-stop').style.display = 'none';
            document.getElementById('btn-dl').style.display = 'block';
        }

        function descargarCSV() {
            let csv = "Tiempo_s,Z_Impacto,BPM\n";
            memoria.forEach(f => csv += `${f.t},${f.z},${f.bpm}\n`);
            let blob = new Blob([csv], { type: 'text/csv' });
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url; a.download = `sesion_escalar_${Date.now()}.csv`;
            a.click();
        }
    </script>
</body>
</html>

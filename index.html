<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrónomo Vital Z</title>
    <style>
        body { background: #000; color: #00FF00; font-family: 'Courier New', monospace; text-align: center; padding: 20px; }
        #consola { border: 2px solid #00FF00; padding: 20px; background: rgba(0,20,0,1); max-width: 300px; margin: 0 auto; }
        #fase-box { font-size: 20px; font-weight: bold; margin: 20px 0; height: 30px; }
        #val-z { color: #FFD700; font-size: 24px; }
        #btn-start { padding: 25px; background: #4B0082; color: white; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; }
        .pulso-visual { width: 100px; height: 100px; border-radius: 50%; border: 2px solid #0f0; margin: 20px auto; transition: all 0.1s; }
    </style>
</head>
<body>

    <h2>METRÓNOMO RESPIRATORIO</h2>
    <div id="consola">
        EJE Z (PRESIÓN):<br>
        <span id="val-z">0.00</span>
        <div id="fase-box">ESPERANDO...</div>
    </div>

    <div id="v-pulso" class="pulso-visual"></div>

    <button id="btn-start" onclick="iniciarMetronomo()">INICIAR GUÍA SONORA</button>

    <script>
        let aCtx, osc, gain;
        let ultimaFase = ""; // Para evitar que el sonido se repita infinitamente

        async function iniciarMetronomo() {
            document.getElementById('btn-start').style.display = 'none';
            aCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            window.addEventListener('devicemotion', (e) => {
                let z = e.acceleration.z || 0;
                document.getElementById('val-z').innerText = z.toFixed(3);

                // LÓGICA DE DETECCIÓN DE CAMBIO DE FASE
                if (z > 0.1) {
                    if (ultimaFase !== "INHALA") {
                        dispararSonido(528, 0.3); // Tono de reparación al inhalar
                        actualizarUI("INHALANDO", "#00FF00", 1.5);
                        ultimaFase = "INHALA";
                    }
                } else if (z < -0.1) {
                    if (ultimaFase !== "EXHALA") {
                        dispararSonido(396, 0.2); // Tono de liberación al exhalar
                        actualizarUI("EXHALANDO", "#FF4500", 0.8);
                        ultimaFase = "EXHALA";
                    }
                }
            });
        }

        function dispararSonido(freq, vol) {
            // Crea un oscilador momentáneo para cada "latido" respiratorio
            let o = aCtx.createOscillator();
            let g = aCtx.createGain();
            o.type = 'sine';
            o.frequency.setValueAtTime(freq, aCtx.currentTime);
            g.gain.setValueAtTime(0, aCtx.currentTime);
            g.gain.linearRampToValueAtTime(vol, aCtx.currentTime + 0.1);
            g.gain.exponentialRampToValueAtTime(0.001, aCtx.currentTime + 0.6);
            
            o.connect(g).connect(aCtx.destination);
            o.start();
            o.stop(aCtx.currentTime + 0.7);
        }

        function actualizarUI(texto, color, escala) {
            let box = document.getElementById('fase-box');
            let vis = document.getElementById('v-pulso');
            box.innerText = texto;
            box.style.color = color;
            vis.style.borderColor = color;
            vis.style.transform = `scale(${escala})`;
            vis.style.boxShadow = `0 0 20px ${color}`;
        }
    </script>
</body>
</html>
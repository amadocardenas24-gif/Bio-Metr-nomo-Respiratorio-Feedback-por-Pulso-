<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escucha Directa Vital</title>
    <style>
        body { background: #000; color: #00FF00; font-family: monospace; text-align: center; padding: 20px; }
        .consola { border: 2px solid #00FF00; padding: 25px; background: #010; border-radius: 20px; }
        #vumetro { width: 100%; height: 20px; background: #020; border: 1px solid #0f0; margin: 15px 0; overflow: hidden; }
        #barra { width: 0%; height: 100%; background: #0f0; transition: width 0.1s; }
        .instruccion { color: #FFD700; font-size: 14px; margin-bottom: 20px; }
        #btn-play { padding: 20px; background: #8B0000; color: #fff; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; width: 100%; }
    </style>
</head>
<body>

    <h2>MONITOR DE AUDIO DIRECTO</h2>
    <p class="instruccion">USA AURICULARES<br>El sistema amplifica el sonido real del pecho.</p>

    <div class="consola">
        NIVEL DE ENTRADA:
        <div id="vumetro"><div id="barra"></div></div>
        ESTADO: <span id="status">EN ESPERA</span>
    </div>

    <br>
    <button id="btn-play" onclick="activarAudioDirecto()">ABRIR CANAL DE AUDIO</button>

    <script>
        let aCtx, analista, dataArray;

        async function activarAudioDirecto() {
            document.getElementById('btn-play').style.display = 'none';
            aCtx = new (window.AudioContext || window.webkitAudioContext)();

            try {
                // Pedimos el audio sin procesamientos automáticos para no perder el latido
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: false, 
                        noiseSuppression: false, 
                        autoGainControl: true 
                    } 
                });

                const fuente = aCtx.createMediaStreamSource(stream);
                
                // FILTRO DE SINTONÍA: Solo dejamos pasar frecuencias de 20Hz a 100Hz (el corazón)
                const filtro = aCtx.createBiquadFilter();
                filtro.type = "lowpass";
                filtro.frequency.value = 100;
                filtro.Q.value = 1.5;

                // AMPLIFICADOR DE GANANCIA: Sube el volumen del latido débil
                const ganancia = aCtx.createGain();
                ganancia.gain.value = 8.0; // Multiplica x8 la señal original

                // ANALIZADOR VISUAL
                analista = aCtx.createAnalyser();
                analista.fftSize = 256;
                dataArray = new Uint8Array(analista.frequencyBinCount);

                // Conexión del circuito
                fuente.connect(filtro);
                filtro.connect(ganancia);
                ganancia.connect(analista);
                ganancia.connect(aCtx.destination); // Envío directo a auriculares

                document.getElementById('status').innerText = "ESCUCHANDO...";
                document.getElementById('status').style.color = "#0f0";
                
                actualizarVumetro();
            } catch (err) {
                alert("Error al acceder al micrófono: " + err);
            }
        }

        function actualizarVumetro() {
            analista.getByteFrequencyData(dataArray);
            let promedio = dataArray.reduce((a, b) => a + b) / dataArray.length;
            document.getElementById('barra').style.width = (promedio * 2) + "%";
            requestAnimationFrame(actualizarVumetro);
        }
    </script>
</body>
</html>
